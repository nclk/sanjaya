# Sanjaya UI — React + MUI MVP Implementation Plan

> Reusable React component library for the Sanjaya dynamic reporting
> platform. Built with MUI 7, AG Grid Enterprise 32, and TypeScript.
> The host app injects a `SanjayaClient` implementation — the library
> owns no networking, caching, or auth logic.

## Architecture Overview

A React component library (`@pojagi/sanjaya-ui`) that exports composable
components and a provider. The host application implements the
`SanjayaClient` interface and wraps the component tree in
`<SanjayaProvider>`. Components never assume endpoint URLs,
authentication strategy, or HTTP library.

```
┌──────────────────────────────────────────────────────────────────────┐
│  Host Application                                                    │
│                                                                      │
│  <SanjayaProvider client={mySanjayaClient}>                          │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  <ReportBuilder>                                               │  │
│  │  ┌──────────────┐ ┌──────────────────┐ ┌───────────────────┐  │  │
│  │  │ Dataset      │ │ Column           │ │ Filter            │  │  │
│  │  │ Picker       │ │ Selector         │ │ Builder           │  │  │
│  │  └──────────────┘ └──────────────────┘ └───────────────────┘  │  │
│  │  ┌──────────────────┐  ┌────────────────────────────────────┐ │  │
│  │  │ Pivot            │  │ DataGrid (AG Grid SSRM)            │ │  │
│  │  │ Configurator     │  │ Table + Pivot tabs                 │ │  │
│  │  └──────────────────┘  └────────────────────────────────────┘ │  │
│  │  ┌────────────────────────────────────────────────────────────┐│  │
│  │  │ Toolbar: Save, Export, Actions menu, Dirty indicator      ││  │
│  │  └────────────────────────────────────────────────────────────┘│  │
│  └────────────────────────────────────────────────────────────────┘  │
│                        │                                             │
│         ┌──────────────┴──────────────┐                              │
│         │ Host-provided SanjayaClient │                              │
│         │ (any HTTP client, caching,  │                              │
│         │  auth strategy the host     │                              │
│         │  already uses)              │                              │
│         └─────────────────────────────┘                              │
└──────────────────────────────────────────────────────────────────────┘
```

### Technology choices

| Concern | Choice | Rationale |
|---------|--------|-----------|
| UI framework | React ^18.3.1 | Host team's existing stack; enables rapid prototyping |
| Component library | MUI ^7.2.0 | Rich form controls, theming, layout primitives |
| Grid | AG Grid Enterprise ^32.0.0 via `ag-grid-react` | SSRM, pivot, row grouping — Enterprise features |
| Package scope | `@pojagi/sanjaya-ui` | All published JS/TS packages use the `@pojagi` npm scope |
| Data access | `SanjayaClient` interface (host-injected via React context) | Library owns no networking — host controls HTTP, auth, caching |
| Types | Hand-authored TS types + auto-generated from OpenAPI via `openapi-typescript` | Keep in sync with TypeSpec; host can also import TypeSpec sources directly |
| State management | `useReducer` in ReportBuilder orchestrator | Minimal footprint — no additional dependencies |
| Drag-and-drop | HTML5 native DnD API | Zero-dependency; sufficient for zone-based drag (Available → Rows / Pivot / Values) |
| Build | Vite library mode + `tsc` | ESM output with declarations; peer deps externalized |
| Tests | Vitest + React Testing Library | Fast, modern test tooling |
| Licensing | AG Grid Enterprise runs fully without a license key (shows watermark) | Host injects `LicenseManager.setLicenseKey()` in their own entry point |

---

## Package scaffold

```
packages/sanjaya-ui/
├── package.json                      # @pojagi/sanjaya-ui
├── tsconfig.json
├── vite.config.ts                    # Library mode, peer deps externalized
├── README.md
├── src/
│   ├── index.ts                      # Public entry — re-exports everything
│   ├── api/
│   │   ├── types.ts                  # Hand-written ergonomic TS types
│   │   ├── generated.ts             # Auto-generated by openapi-typescript
│   │   └── client.ts                # SanjayaClient interface
│   ├── providers/
│   │   └── SanjayaProvider.tsx       # React context provider + useSanjayaClient hook
│   ├── state/
│   │   └── reportBuilderState.ts     # Reducer, actions, dirty tracking
│   └── components/
│       ├── index.ts                  # Barrel exports
│       ├── DatasetPicker.tsx         # MUI Autocomplete dataset selector
│       ├── ColumnSelector.tsx        # Checkbox list with type grouping
│       ├── FilterBuilder.tsx         # Recursive FilterGroup/FilterCondition editor
│       ├── PivotConfigurator.tsx     # DnD zone builder for row groups / pivot / values
│       ├── DataGrid.tsx              # AG Grid SSRM wrapper (Table + Pivot tabs)
│       └── ReportBuilder.tsx         # Top-level orchestrator (sidebar + grid + toolbar)
└── tests/                            # (future) Vitest + RTL tests
```

---

## Phase 1 — Types, client interface, provider, state

### 1.1 `SanjayaClient` interface

Defined in `src/api/client.ts`. The host implements this and passes it to
`<SanjayaProvider>`. Methods map 1:1 to the Sanjaya REST surface:

```ts
interface SanjayaClient {
  // Datasets
  listDatasets(): Promise<DatasetsResponse>;
  getColumns(datasetKey: string): Promise<ColumnsResponse>;
  preview(datasetKey: string, body: PreviewRequest): Promise<PreviewResponse>;

  // SSRM endpoints
  tableQuery(datasetKey: string, body: TableGetRowsRequest): Promise<ServerSideGetRowsResponse>;
  pivotQuery(datasetKey: string, body: ServerSideGetRowsRequest): Promise<ServerSideGetRowsResponse>;

  // Export (returns a Blob)
  exportData(datasetKey: string, body: ExportRequest): Promise<Blob>;

  // Reports CRUD
  listReports(params?): Promise<ListDynamicReportsResponse>;
  getReport(reportId: string): Promise<DynamicReport>;
  createReport(body: CreateDynamicReportRequest): Promise<DynamicReport>;
  updateReport(reportId: string, body: UpdateDynamicReportRequest): Promise<DynamicReport>;

  // Lifecycle actions
  getAvailableActions(reportId: string): Promise<AvailableActionsResponse>;
  performAction(reportId: string, body: PerformDynamicReportActionRequest): Promise<DynamicReportActionResponse>;
  getReportStats(): Promise<DynamicReportStats>;

  // Shares
  listShares(reportId: string): Promise<ListDynamicReportSharesResponse>;
  upsertUserShare(reportId, body): Promise<ListDynamicReportSharesResponse>;
  deleteUserShare(reportId, body): Promise<ListDynamicReportSharesResponse>;
  upsertGroupShare(reportId, body): Promise<ListDynamicReportSharesResponse>;
  deleteGroupShare(reportId, body): Promise<ListDynamicReportSharesResponse>;
}
```

The library ships **no** default implementation. The host provides its own
(backed by `fetch`, `axios`, `openapi-fetch`, React Query, or whatever it
already uses). This means:

- No networking dependencies in the library.
- No assumptions about base URLs, auth headers, or CSRF tokens.
- No React Query hooks to maintain — the host owns data-fetching strategy.

Hosts wanting auto-generated type-safe clients can import the TypeSpec
sources from `api/` directly into their own TypeSpec projects, or use
`openapi-typescript` + `openapi-fetch` against the published OpenAPI spec.

### 1.2 TypeScript types

Hand-written ergonomic types in `src/api/types.ts` that mirror the
TypeSpec / OpenAPI specification. All component props and the
`SanjayaClient` interface reference these types.

The `generate:types` npm script runs `openapi-typescript` against the
compiled `openapi.yaml` to produce `src/api/generated.ts`. This provides
a raw path-level type tree for advanced usage but is not required for
basic component consumption.

Key type groups:

| Group | Types |
|-------|-------|
| Enums | `ColumnType`, `FilterOperator`, `FilterCombinator`, `AggFunc`, `ExportFormat`, `DynamicReportAction`, `DynamicReportStatus`, `DynamicReportPermission` |
| Column metadata | `Column`, `ColumnFormatHints`, `ColumnPivotOptions`, `CurrencyOptions` |
| Filters | `FilterCondition`, `FilterGroup` |
| AG Grid wire | `ColumnVO`, `SortModelItem`, `SSRMBaseRequest`, `TableGetRowsRequest`, `ServerSideGetRowsRequest`, `ServerSideGetRowsResponse`, `PivotResultColDef` |
| Datasets | `Dataset`, `DatasetsResponse`, `ColumnsResponse` |
| Reports | `DynamicReport`, `DynamicReportSummary`, `DynamicReportDefinition`, `DynamicReportMetadata`, CRUD requests/responses |
| Shares | `DynamicReportUserShare`, `DynamicReportGroupShare`, upsert/delete requests |
| Errors | `ErrorDetail`, `CustomErrorResponse` |

### 1.3 `<SanjayaProvider>` and `useSanjayaClient()`

A simple React context provider. All Sanjaya components call
`useSanjayaClient()` internally to get the host-injected client:

```tsx
<SanjayaProvider client={mySanjayaClient}>
  <ReportBuilder />
</SanjayaProvider>
```

`useSanjayaClient()` throws a clear error if used outside a provider.

### 1.4 Report builder state

Managed via `useReducer` in the `ReportBuilder` orchestrator. State shape:

```ts
interface ReportBuilderState {
  datasetKey: string | null;
  columns: Column[];
  datasets: Dataset[];
  selectedColumns: string[];
  filterGroup: FilterGroup;
  rowGroupCols: ColumnVO[];
  pivotCols: ColumnVO[];
  valueCols: ColumnVO[];
  sortModel: SortModelItem[];
  activeTab: "table" | "pivot";
  loading: { datasets: boolean; columns: boolean };
  error: string | null;
  lastSavedSnapshot: SavedSnapshot | null;
}
```

Actions dispatch state changes; `isDirty()` compares the current snapshot
against the last-saved snapshot via deep equality.

### 1.5 Deliverables

- [x] Package scaffolded (Vite library mode, peer deps, tsconfig)
- [x] `SanjayaClient` interface defined
- [x] All TS types exported from entry point
- [x] `SanjayaProvider` + `useSanjayaClient()` hook
- [x] Reducer, actions, `isDirty()`, `extractSnapshot()`
- [ ] Tests for state reducer and dirty tracking

---

## Phase 2 — `<DatasetPicker>`

### Behavior

- MUI `Autocomplete` fed by datasets (either pre-loaded via props or
  fetched on mount via `client.listDatasets()`).
- Searchable single-select. Each option shows the dataset label and
  description.
- Selecting a dataset calls `onChange(datasetKey)`. The parent
  orchestrator handles column fetching and dependent state resets.

### Props

| Name | Type | Description |
|------|------|-------------|
| `value` | `string \| null` | Currently selected dataset key |
| `onChange` | `(key: string \| null) => void` | Selection callback |
| `datasets` | `Dataset[]` | Optional pre-loaded datasets (skip fetch) |
| `disabled` | `boolean` | Disable the control |

### 2.1 Deliverables

- [x] `DatasetPicker` component
- [x] Searchable dropdown with dataset description
- [x] Supports both pre-loaded and fetched datasets
- [ ] Tests: selection, search, loading state

---

## Phase 3 — `<ColumnSelector>`

### Behavior

- MUI checkbox list with columns grouped by `ColumnType`.
- "Select All" / "Clear" buttons.
- Shows selection count (`n / total`).
- Selection drives AG Grid `columnDefs` and the export `selectedColumns`.

### Props

| Name | Type | Description |
|------|------|-------------|
| `columns` | `Column[]` | Full column metadata |
| `selectedColumns` | `string[]` | Currently selected column names |
| `onChange` | `(selected: string[]) => void` | Selection callback |
| `disabled` | `boolean` | Disable all controls |

### 3.1 Deliverables

- [x] `ColumnSelector` component
- [x] Grouped by column type with type labels
- [x] Select all / clear
- [ ] Tests: toggle, select all, clear

---

## Phase 4 — `<FilterBuilder>`

### Behavior

A recursive component that renders `FilterGroup` / `FilterCondition`
trees using MUI form controls. This is the full "advanced mode" editor —
nested groups with AND/OR combinators, per-condition NOT support, and
operator-driven value inputs.

#### Value input adaptation

The value input adapts based on the column type and selected operator:

| Condition | Input type |
|-----------|-----------|
| `filterStyle: "select"` with `enumValues` | MUI `Autocomplete` (single-select from enum values) |
| `operator: "in"` | MUI `Autocomplete` (multi-select, free-form tags) |
| `operator: "between"` | Two `TextField` inputs (From – To) |
| `operator: "isNull"` / `"isNotNull"` | No value input |
| Default | `TextField` |

#### Group rendering

Each group is a `Paper` with outlined variant and a colored left border
(alternating colors by depth). Groups contain:
- Combinator selector (AND / OR) — MUI `Select`
- NOT chip (if negated)
- Add condition / Add group / Remove group buttons
- Nested conditions and sub-groups

### Props

| Name | Type | Description |
|------|------|-------------|
| `columns` | `Column[]` | Column metadata (drives operator lists, enum values) |
| `filterGroup` | `FilterGroup` | Current filter tree |
| `onChange` | `(fg: FilterGroup) => void` | Called on every change |
| `disabled` | `boolean` | Disable all controls |

### 4.1 Deliverables

- [x] `FilterBuilder` component
- [x] Recursive group rendering with AND/OR/NOT
- [x] Operator-driven value input adaptation
- [x] `filterStyle: "select"` renders enum dropdown
- [x] `between` renders two inputs
- [x] `in` renders tag input
- [ ] Tests: add/remove conditions, nested groups, operator adaptation

---

## Phase 5 — `<PivotConfigurator>`

### Behavior

Three drop zones (plus an "Available Columns" pool) using HTML5 native
drag-and-drop. No external DnD library required.

| Zone | Purpose | Accepts | Maps to |
|------|---------|---------|---------|
| **Available** | Pool of unassigned columns | — | — |
| **Row Groups** | Row-group dimensions | Any column | `rowGroupCols: ColumnVO[]` |
| **Pivot Columns** | Cross-tab dimensions (pivot mode) | Any column | `pivotCols: ColumnVO[]` |
| **Values** | Measures with agg function | Any column | `valueCols: ColumnVO[]` with `aggFunc` |

- Drag from Available → any zone to add.
- Drag between zones to move.
- Click × on a chip to return it to Available.
- Values zone shows an `aggFunc` dropdown per chip, constrained by the
  column's `pivot.allowedAggs` (falls back to all agg funcs).
- `hidePivotZone` prop hides the Pivot Columns zone (for datasets without
  pivot capability).

### Props

| Name | Type | Description |
|------|------|-------------|
| `columns` | `Column[]` | Column metadata |
| `rowGroupCols` | `ColumnVO[]` | Current row group columns |
| `pivotCols` | `ColumnVO[]` | Current pivot columns |
| `valueCols` | `ColumnVO[]` | Current value columns |
| `onRowGroupColsChange` | `(cols) => void` | Row groups changed |
| `onPivotColsChange` | `(cols) => void` | Pivot columns changed |
| `onValueColsChange` | `(cols) => void` | Value columns changed |
| `hidePivotZone` | `boolean` | Hide pivot zone for non-pivot datasets |
| `disabled` | `boolean` | Disable all controls |

### 5.1 Deliverables

- [x] `PivotConfigurator` component
- [x] HTML5 DnD between Available and three zones
- [x] `aggFunc` picker constrained by `allowedAggs`
- [x] Visual feedback on drag-over (dashed border, highlight)
- [x] `hidePivotZone` support
- [ ] Tests: drag between zones, agg selection, remove

---

## Phase 6 — `<DataGrid>` (AG Grid SSRM)

### Behavior

Wraps `<AgGridReact>` in SSRM mode. Implements a custom
`IServerSideDatasource` that:

1. Reads **structural** params from AG Grid (pagination, `groupKeys`,
   `sortModel`).
2. Injects **semantic** params from props (`filter`, `rowGroupCols`,
   `valueCols`, `pivotCols`) — matching the pattern in
   [ui-integration-notes.md](ui-integration-notes.md).
3. Calls `client.tableQuery()` or `client.pivotQuery()` depending on
   `activeTab`.
4. Applies `secondaryColDefs` from pivot responses.
5. Refreshes on dependency changes (`purge: true`).

MUI `Tabs` toggle between Table and Pivot modes.

### Props

| Name | Type | Description |
|------|------|-------------|
| `datasetKey` | `string` | Active dataset |
| `columns` | `Column[]` | Column metadata (→ ColDefs) |
| `selectedColumns` | `string[]` | Visible columns |
| `filterGroup` | `FilterGroup` | Active filter tree |
| `rowGroupCols` | `ColumnVO[]` | Row group columns |
| `pivotCols` | `ColumnVO[]` | Pivot columns |
| `valueCols` | `ColumnVO[]` | Value columns |
| `sortModel` | `SortModelItem[]` | Sort model |
| `activeTab` | `"table" \| "pivot"` | Current tab |
| `pivotCapable` | `boolean` | Show/hide pivot tab |
| `onActiveTabChange` | `(tab) => void` | Tab change callback |
| `onSortModelChange` | `(sort) => void` | Sort changed in grid |

### 6.1 Deliverables

- [x] `DataGrid` component
- [x] SSRM datasource → `client.tableQuery()` / `client.pivotQuery()`
- [x] Definition-driven column defs (selected columns, row groups, value aggs)
- [x] Pivot `secondaryColDefs` applied from response
- [x] Tab switching (Table / Pivot)
- [x] Refresh on filter/column/sort/tab changes
- [ ] Tests: datasource construction, col def mapping (mocked grid API)

---

## Phase 7 — `<ReportBuilder>` orchestrator

### Responsibilities

1. **Compose** all child components into a MUI layout:
   - Persistent `Drawer` sidebar with dataset picker, column selector
     (in an `Accordion`), filter builder (in an `Accordion`), and pivot
     configurator (in an `Accordion`).
   - Main content area with the `DataGrid`.
   - `AppBar` toolbar with sidebar toggle, report title, dirty indicator,
     save button, export button, favorite toggle, and actions overflow menu.

2. **Manage state** via `useReducer(reportBuilderReducer, initialState)`.
   Dataset changes reset dependent state. Column metadata loads trigger
   auto-selection of all columns.

3. **Dirty tracking**: `isDirty()` compares current state snapshot against
   `lastSavedSnapshot`. The save button is disabled when clean.

4. **Save / Load**: Save builds a `DynamicReportDefinition` from state and
   calls `client.createReport()` or `client.updateReport()`. Load hydrates
   the reducer from a `DynamicReport`'s `metadata.definition`, including
   `rowGroupCols`, `pivotCols`, `valueCols`, and `sortModel`.

5. **Actions menu** (MUI `Menu`): driven by `availableActions` from the
   report response:

   | Action | Behavior |
   |--------|----------|
   | Favorite | Toggle (separate star icon in toolbar) |
   | Publish / Unpublish | `client.performAction()` |
   | Archive / Restore | `client.performAction()` |
   | Share | `client.performAction()` (dialog in future phase) |
   | Transfer Ownership | `client.performAction()` |
   | Delete | `client.performAction()` → `onDeleted()` callback |
   | Export CSV / XLSX | `client.exportData()` with variant based on tab state |

6. **Export variant selection**: based on current UI state:
   - Table tab, no row groups → `flat` export
   - Table tab, with row groups → `grouped` export
   - Pivot tab → `pivot` export

### Props

| Name | Type | Description |
|------|------|-------------|
| `report` | `DynamicReport` | Report to load (edit mode); omit for new |
| `onSaved` | `(report) => void` | Called after successful save |
| `onDeleted` | `() => void` | Called after successful delete |
| `sidebarWidth` | `number` | Sidebar width (default 320) |

### 7.1 Deliverables

- [x] `ReportBuilder` component
- [x] All child components composed and wired
- [x] `useReducer` state management with dirty tracking
- [x] Save / load round-trip with `DynamicReportDefinition`
- [x] Actions menu driven by `availableActions`
- [x] Export with variant selection (flat / grouped / pivot)
- [x] Favorite toggle in toolbar
- [x] Collapsible sidebar
- [x] Error banner and snackbar notifications
- [ ] Tests: state coordination, dirty transitions, save flow, action dispatch

---

## Phasing summary

| Phase | Component | Key outcome |
|-------|-----------|-------------|
| **1** | Types + client + provider + state | Foundation: TS types, `SanjayaClient` interface, React context, reducer |
| **2** | `<DatasetPicker>` | MUI Autocomplete dataset selection |
| **3** | `<ColumnSelector>` | Checkbox list with type grouping |
| **4** | `<FilterBuilder>` | Recursive FilterGroup tree editor with operator-driven inputs |
| **5** | `<PivotConfigurator>` | HTML5 DnD zone builder for row groups / pivot / values |
| **6** | `<DataGrid>` | AG Grid SSRM wrapper with Table + Pivot tabs |
| **7** | `<ReportBuilder>` | Full orchestrator with sidebar, toolbar, save/load, actions |
| **8** | [Demo app + integration](ui-mvp-integration-plan.md) | Demo React app with fetch-based SanjayaClient |

Phases 2–6 can be developed in parallel once Phase 1 is complete. Phase 7
composes all prior work. Phase 8 is covered in the integration plan.

---

## Dependencies on backend changes

Several features require additions to the backend API. These are detailed
in [`backend-addenda.md`](backend-addenda.md):

| Item | Status | Blocks |
|------|--------|--------|
| Pivot definition persistence (`rowGroupCols`, `pivotCols`, `valueCols`, `sortModel`) | ✅ Implemented in TypeSpec + OpenAPI | Phase 7 save/load |
| Favorite action (`isFavorited`, `DynamicReportFavorite` model) | ✅ Implemented in TypeSpec + OpenAPI | Phase 7 actions menu |
